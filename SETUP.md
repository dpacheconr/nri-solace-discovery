# Setting Up the New Relic Solace Integration

This document explains how to set up the fully automated Solace integration that dynamically discovers all VPNs, queues, topic endpoints, and collects detailed statistics.

## Prerequisites

- A Solace PubSub+ broker or Solace Cloud instance
- New Relic account and license key
- Docker and Docker Compose installed on your system

## Configuration Steps

### 1. Configure Solace Environment

Create a copy of the `config/solace-env-config.example.yml` file as `config/solace-env-config.yml` and update it with your Solace connection details:

```yaml
SOLACE_BASE_URL: "https://your-solace-instance.messaging.solace.cloud:943/SEMP/v2/monitor"
SOLACE_USERNAME: "your-solace-username"
SOLACE_PASSWORD: "your-solace-password"
```

### 2. Configure New Relic

Make sure your New Relic license key is properly configured in `nr-infra/newrelic-infra.yml`:

```yaml
license_key: YOUR_NEW_RELIC_LICENSE_KEY
```

### 3. Build and Start the Integration Container

Build and start the Docker container using Docker Compose:

```bash
docker-compose build
docker-compose up -d
```

## How the Integration Works

The integration uses the New Relic Flex framework to collect data from Solace in the following steps:

1. **Discovery**: The integration automatically discovers all message VPNs on your Solace instance.
2. **Resource Enumeration**: For each discovered VPN, it finds all queues and topic endpoints.
3. **In-Memory Storage**: All discovered resources are stored in memory using Flex variables with appropriate TTL values.
4. **Metrics Collection**: It collects detailed metrics for every discovered resource:
   - Queue statistics
   - Topic endpoint statistics
   - VPN-level metrics
   - Bridge statistics
   - Client connection statistics

## Optimized Variable-Based Discovery

This integration uses Flex's variable capabilities (`store_variables`, `lookup_variable`, etc.) for efficient resource discovery:

- **Enhanced Performance**: Using in-memory variables instead of temporary files improves performance
- **TTL Management**: Variables have a configurable Time-To-Live to ensure freshness
- **Reduced I/O Operations**: Eliminates filesystem operations for resource tracking
- **Clean State Management**: Variables are properly scoped within the Flex execution context
   - Client connection statistics

All of this happens automatically without requiring manual configuration of VPN names, queue names, or topic endpoint names.

## New Relic Dashboard

You can create a New Relic dashboard to visualize the collected data. Here are the main event types generated by this integration:

- `SolaceVPNSummary`: Summary of VPN information
- `SolaceQueueSummary`: Summary of queue information
- `SolaceTopicEndpointSummary`: Summary of topic endpoint information
- `SolaceQueueMetrics`: Detailed metrics for each queue
- `SolaceTopicEndpointMetrics`: Detailed metrics for each topic endpoint
- `SolaceVPNDetailedMetrics`: Detailed VPN metrics
- `SolaceBridgeMetrics`: Bridge metrics for each VPN
- `SolaceClientMetrics`: Client connection metrics for each VPN

You can use these event types to create NRQL queries for your dashboards.

## Troubleshooting

If the integration is not working as expected, check the following:

1. Verify that your Solace connection details are correct
2. Check the Docker container logs: `docker-compose logs nri_solace`
3. Ensure that your New Relic license key is valid
4. Verify that the Solace user has sufficient permissions to access SEMP API endpoints

For more help, please refer to the New Relic and Solace documentation.
